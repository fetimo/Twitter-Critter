<div id="content">
<?r unless @critter.nil? ?>	
	<div class="preloader_container"><img class="loader" alt="Loading icon" src="../images/spinner.gif"></div>	
	<canvas id="your-critter" class="critter_container" width="1000" height="500">Critter requires canvas, upgrade to a nice browser.</canvas>
	<?r if session[:access_token] and @username === session[:access_token].params[:screen_name] ?>
	<aside class="alerts">
		<!-- alerts to be dynamically generated and placed inside here -->
		#{flashbox}
		<section class="weapon_selection alert alert-info">
			<a class="close" data-dismiss="alert">&times;</a>
			<?r if @fisticuffs_tutorial ?>
				<h4>First time here?</h4>
				<p>If you start fisticuffs with someone then they will see a message when they login telling them what to do next. If you win the fight you'll be able to choose a feature of theirs that you like to have yourself!</p>
				<br>
			<?r end ?>
			<h4>Choose Your Weapon</h4>
			<img alt="Icon of rock" id="3" src="../images/weapons/rock.png">
			<img alt="Icon of paper" id="2" src="../images/weapons/paper.png">
			<img alt="Icon of scissors" id="1" src="../images/weapons/scissors.png">
		</section>
		<?r 
	if flash[:Fisticuffs] and flash[:Fisticuffs].include? 'win'
		uid = session[:access_token].params[:user_id]
		begin
			you = DB[:interactions].filter(:uid => uid).first
			@theirs = Twitter.user(you[:opponent]).screen_name
			show_js = true
			@opp_attribs = DB[:critters].filter(:uid => you[:opponent]).select(:arms, :eye_colour, :ears, :mouth, :legs, :face, :hands, :nose, :body_colour, :body, :body_type, :accessory).first #=> returns hash of attributes
			@timestamp = you[:start]
			?> <div class="alert alert-info">
				<a class='close' data-dismiss='alert'>&times;</a>
				<p>Now that you've won, you can choose an attribute of theirs to have for yourself.
				<br>
				Give me their&hellip;</p>
				<ul id="attributes"> <?r
				@opp_attribs.each do |r| ?>
					#{ render_partial :attribute, { :attribute=>r[0].to_s, :value=>r[1] } }
				<?r	end ?>
				</ul>
			</div>
		<?r rescue => e
			message = e.message
			?> <p>#{message}</p> <?r	
		end
	?>
<?r 
	elsif flash[:Fisticuffs] and flash[:Fisticuffs].include? 'draw'
		uid = session[:access_token].params[:user_id]
		begin
			require 'net/http'
			http = Net::HTTP.new("crittr.me")
			request = Net::HTTP::Delete.new("/api/battle?uid=#{uid}")
			message = http.request(request)
		rescue => e
			message = e.message
		end
	end 
	flash.delete(:Fisticuffs)
	?>
	</aside>

	<section class="friends">
			<?r if session[:friends].count > 4 ?>
		<div class="scroll_arrows" id="left_scroll"><img src="../images/back.png" alt="Backwards"></div>
			<?r end ?>
		<div id="carousel_inner">  
	    	<ul> 
				<?r session[:friends].sort.each do |f| #from http://blog.xambr.com/2009/11/26/ramaze-partials-with-etanni/ ?>
			    	#{ render_partial :friend, { :friend=>f } }
				<?r end ?>
				<?r if @suggested_friend ?>
					<li id="lonely">You look a bit lonely,<br>why not make a Critter for <a href="/user/#{@suggested_friend['username']}">#{@suggested_friend['name']}</a>?</li>
				<?r end ?>
			</ul>
		</div>
			<?r if session[:friends].count > 4 ?>
		<div class="scroll_arrows" id='right_scroll'><img src="../images/next.png" alt="Forwards"></div>
			<?r end ?>
	</section>
	<?r end ?>
</div>
<!-- libraries -->
#{js('easel/lib/easel')}
#{js('easel/src/easeljs/filters/Filter')}
#{js('easel/src/easeljs/filters/ColorFilter')}
#{js('underscore')}
#{js('backbone')}
#{js('alert')}
<!-- app logic -->
#{js('carousel')}
#{js('your-critter')}
<script>
var username = '#{@username}';
</script>
#{js('app')}
#{js('friends')}
#{js('animation')}
	<?r if show_js ?>
	<script>
	if (document.getElementById('attributes')) {		
		var critter_container2 = new Container(),
			friend = critterApp.critter("#{@theirs}"),
			theirs = build(friend, critterApp.theirStage(), critter_container2);
			
		$('#attributes').children().on('click', function() {
			$.ajax({
				type: 'POST',
				url: 'http://crittr.me/api/battle?uid=' + critterApp.yourModel().get('uid') + '&attribute=' + this.id + '&hash='+#{@timestamp},
				complete: function() {
					$('.alert').remove();
					critterApp.yourStage().removeAllChildren();
					var your_critter = critterApp.yourModel();
					your_critter.fetch(); 
					critter = build(your_critter, critterApp.yourStage(), critterApp.yours().getContainer()); 
					critterApp.yourStage().update();
					critterApp.theirStage().removeAllChildren();
				}
			});
		});
	}
	</script>
	<?r end ?>
<?r else ?>
<p>No Critter called #{@username} exists yet! You can <a href="/user/#{@username}">give life to it though</a>.</p>
<?r end ?>