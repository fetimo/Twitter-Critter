<div id="content">
<?r unless @critter.nil? ?>	
	<div class="preloader_container"><img class="loader" src="../images/spinner.gif"></div>
	<canvas id="your-critter" class="critter_container" width="1000" height="500">Critter requires canvas, upgrade to a nice browser.</canvas>
	<?r if session[:access_token] and @username === session[:access_token].params[:screen_name] ?>
	<section class="weapon_selection">
		<ul>
			<li><img name="3" src="../images/weapons/1.png">Rock</li>
			<li><img name="2" src="../images/weapons/2.png">Paper</li>
			<li><img name="1" src="../images/weapons/3.png">Scissors</li>
		</ul>
	</section>
	#{flashbox}
	<?r if flash[:Fisticuffs] and flash[:Fisticuffs].include? 'win' 
			uid = session[:access_token].params[:user_id]
			begin
				you = DB[:battle_system].filter(:uid => uid).first
				@opp_attribs = DB[:critters].filter(:uid => you[:opponent]).select(:arms, :eye_colour, :ears, :mouth, :legs, :face, :hands, :nose, :body_colour, :body, :body_type, :accessory).first #=> returns hash of attributes
				@timestamp = you[:start]
				?> <ul id="attributes"> <?r
				@opp_attribs.each do |r| ?>
				
					#{ render_partial :attribute, { :attribute=>r[0].to_s, :value=>r[1] } }
				<?r
				end
			rescue => e
				message = e.message
				?> <p>#{message}</p>
	<?r	end 
	flash.delete(:Fisticuffs)
	?>
</div>
	<script>
	if (document.getElementById('attributes')) {		
		$('#attributes').children().on('click', function() {
			$.ajax({
				type: 'POST',
				url: 'http://crittr.me/api/battle?uid=' + your_critter.get('uid') + '&attribute=' + this.id + '&hash='+#{@timestamp},
				success: function() {
					$('#attributes').remove();
					$.ajax({
						type: 'DELETE',
						url: 'http://crittr.me/api/battle?uid='+your_critter.get('uid'),
						success: function() {
							stage.removeAllChildren();
							your_critter.fetch(); 
							critter = build(your_critter, stage, critter_container); 
							stage.update();
						}
					});
				}
			});
		});
	}
</script>
<?r	end ?>
				</ul>
<div class="friends_tab">
	<ul>
		<li><a id="fisticuffs" href="#">Fisticuffs</a></li>
		<li><a id="hug" href="#">Hug</a></li>
	</ul>
</div>
<section class="friends">
		<?r if session[:friends].count > 4 ?>
	<div id="left_scroll"><img src="../images/back.png" alt="Backwards"></div>
		<?r end ?>
	<div id="carousel_inner">  
    	<ul> 
			<?r session[:friends].sort.each do |f| #from http://blog.xambr.com/2009/11/26/ramaze-partials-with-etanni/ ?>
		    	#{ render_partial :friend, { :friend=>f } }
			<?r end ?>
			<?r if @suggested_friend ?>
				<p>You look a bit lonely,<br>why not make a Critter for <a href="/user/#{@suggested_friend['username']}">#{@suggested_friend['name']}</a>?</p>
			<?r end ?>
		</ul>
	</div>
		<?r if session[:friends].count > 4 ?>
	<div id='right_scroll'><img src="../images/next.png" alt="Forwards"></div>
		<?r end ?>
</section>
	<?r end ?>
<!-- libraries -->
#{js('easel/lib/easel')}
#{js('easel/src/easeljs/filters/Filter')}
#{js('easel/src/easeljs/filters/ColorFilter')}
#{js('jquery-ui')}
#{js('underscore')}
#{js('backbone')}
#{js('alert')}
<!-- app logic -->
#{js('carousel')}
#{js('animation')}
#{js('your-critter')}
<script>
/*
	Setup Critter model, url defaults to the username requested
*/
var username = '#{@username}';
var Critter = Backbone.Model.extend({
	url: '../api/critters/' + username,
	initialize: function (username) {
		this.fetch({url: '../api/critters/' + username});
	}
});
var	your_critter = new Critter('#{@username}'),
	elem = document.getElementById('your-critter'),
	stage = new Stage(elem),
	friend_stage = new Stage(elem),
	critter_container = new Container();
friend_stage.autoClear = false;
var critter = build(your_critter, stage, critter_container);
if (document.getElementById('flash_fisticuffs')) {
	//initial new fight
	var str = document.getElementById('flash_fisticuffs').innerHTML,
		strings = str.split(' '),
		friend = new Critter (strings[0]),
		critter_container2 = new Container();
	theirs = build(friend, friend_stage, critter_container2);
}
</script>
#{js('friends')}
<?r else ?>
<p>No Critter called #{@username} exists yet! You can <a href="/user/#{@username}">give life to it though</a>.</p>
<?r end ?>