<div id="content">
	<!--<div class='alert alert-info'>
		<a class='close' data-dismiss='alert'>&times;</a><p><strong>Alert!</strong> A really important piece of information that you need to take action on. <br>
		<button class="btn btn-success">Tweet</button><button class="btn">No, thanks</button> </p>
	</div>-->
<?r unless @critter.nil? ?>	
	<div class="preloader_container"><img class="loader" src="../images/spinner.gif"></div>	
	<canvas id="your-critter" class="critter_container" width="1000" height="500">Critter requires canvas, upgrade to a nice browser.</canvas>
	<section class="weapon_selection">
		<a class="close">&times;</a>
		<ul>
			<li><img name="3" src="../images/weapons/1.png">Rock</li>
			<li><img name="2" src="../images/weapons/2.png">Paper</li>
			<li><img name="1" src="../images/weapons/3.png">Scissors</li>
		</ul>
	</section>
	
	<?r if session[:access_token] and @username === session[:access_token].params[:screen_name] ?>
	#{flashbox}
	<?r 
	if flash[:Fisticuffs] and flash[:Fisticuffs].include? 'win'
		uid = session[:access_token].params[:user_id]
		begin
			you = DB[:interactions].filter(:uid => uid).first
			@opp_attribs = DB[:critters].filter(:uid => you[:opponent]).select(:arms, :eye_colour, :ears, :mouth, :legs, :face, :hands, :nose, :body_colour, :body, :body_type, :accessory).first #=> returns hash of attributes
			@timestamp = you[:start]
			?> <div class="alert alert-info">
				<a class='close' data-dismiss='alert'>&times;</a
				<p>Give me their&hellip;</p>
				<ul id="attributes"> <?r
				@opp_attribs.each do |r| ?>
					#{ render_partial :attribute, { :attribute=>r[0].to_s, :value=>r[1] } }
				<?r	end ?>
				</ul>
			</div>
		<?r rescue => e
			message = e.message
			?> <p>#{message}</p> <?r	
		end
	?>
</div>
	<script>
	if (document.getElementById('attributes')) {		
		$('#attributes').children().on('click', function() {
			$.ajax({
				type: 'POST',
				url: 'http://crittr.me/api/battle?uid=' + your_critter.get('uid') + '&attribute=' + this.id + '&hash='+#{@timestamp},
				complete: function() {
					$('#attributes').remove();
					stage.removeAllChildren();
					your_critter.fetch(); 
					critter = build(your_critter, stage, critter_container); 
					stage.update();
				}
			});
		});
		
		var height = $('.alert').innerHeight(); 
		$('.alert')[1].style.top = height + 'px';
		$('.alert')[1].style.marginTop = '2em';
	}
</script>
<?r 
	elsif flash[:Fisticuffs] and flash[:Fisticuffs].include? 'draw'
		uid = session[:access_token].params[:user_id]
		begin
			require 'net/http'
			http = Net::HTTP.new("crittr.me")
			request = Net::HTTP::Delete.new("/api/battle?uid=#{uid}")
			message = http.request(request)
		rescue => e
			message = e.message
		end
	end 
	flash.delete(:Fisticuffs)
	?>
<div class="friends_tab">
	<ul>
		<li><a id="fisticuffs" href="#">Fisticuffs</a></li>
		<li><a id="hug" href="#">Hug</a></li>
	</ul>
</div>
<section class="friends">
		<?r if session[:friends].count > 4 ?>
	<div id="left_scroll"><img src="../images/back.png" alt="Backwards"></div>
		<?r end ?>
	<div id="carousel_inner">  
    	<ul> 
			<?r session[:friends].sort.each do |f| #from http://blog.xambr.com/2009/11/26/ramaze-partials-with-etanni/ ?>
		    	#{ render_partial :friend, { :friend=>f } }
			<?r end ?>
			<?r if @suggested_friend ?>
				<p>You look a bit lonely,<br>why not make a Critter for <a href="/user/#{@suggested_friend['username']}">#{@suggested_friend['name']}</a>?</p>
			<?r end ?>
		</ul>
	</div>
		<?r if session[:friends].count > 4 ?>
	<div id='right_scroll'><img src="../images/next.png" alt="Forwards"></div>
		<?r end ?>
</section>
	<?r end ?>
<!-- libraries -->
<!--#{js('easel/lib/easel')}-->
#{js('easel/src/easeljs/utils/UID')}
#{js('easel/src/easeljs/display/Shadow')}
#{js('easel/src/easeljs/geom/Matrix2D')}
#{js('easel/src/easeljs/geom/Rectangle')}
#{js('easel/src/easeljs/events/MouseEvent')}
#{js('easel/src/easeljs/display/DisplayObject')}
#{js('easel/src/easeljs/display/Bitmap')}
#{js('easel/src/easeljs/display/Container')}
#{js('easel/src/easeljs/display/Stage')}
#{js('easel/src/easeljs/display/Graphics')}
#{js('easel/src/easeljs/display/Shape')}
#{js('easel/src/easeljs/utils/Ticker')}
#{js('easel/src/easeljs/filters/Filter')}
#{js('easel/src/easeljs/filters/ColorFilter')}
<!--#{js('jquery-ui')}-->
#{js('underscore')}
#{js('backbone')}
<!-- app logic -->
#{js('carousel')}
#{js('your-critter')}
<script>
var username = '#{@username}';
</script>
#{(js('app'))}
#{js('friends')}
#{js('animation')}
<?r else ?>
<p>No Critter called #{@username} exists yet! You can <a href="/user/#{@username}">give life to it though</a>.</p>
<?r end ?>